name: CI

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: gsm_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_pass
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    env:
      BASE_URL: http://127.0.0.1:5050
      FRONTEND_URL: http://127.0.0.1:8000
      MYSQL_USER: test_user
      MYSQL_PASSWORD: test_pass
      MYSQL_DB: gsm_test
      MYSQL_HOST: 127.0.0.1

    steps:
      # -------------------------------------------------
      # Checkout & Python setup
      # -------------------------------------------------
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov pylint

      # -------------------------------------------------
      # Static analysis – Pylint
      # -------------------------------------------------
      - name: Run Pylint
        run: |
          pylint backend/**/*.py || true

      # -------------------------------------------------
      # Unit tests
      # -------------------------------------------------
      - name: Run unit tests
        run: pytest tests/unittest --cov=backend --cov-report=term

      # -------------------------------------------------
      # Start Flask backend
      # -------------------------------------------------
      - name: Start Flask backend (background)
        run: |
          nohup python -m backend.app > /tmp/backend.log 2>&1 &
          echo $! > /tmp/backend.pid

      - name: Wait for backend on :5050
        run: |
          python - <<'PY'
          import socket, time, sys
          deadline = time.time() + 60
          while time.time() < deadline:
              try:
                  sock = socket.socket()
                  sock.settimeout(1)
                  sock.connect(("127.0.0.1", 5050))
                  sock.close()
                  sys.exit(0)
              except Exception:
                  time.sleep(1)
          sys.exit("Backend did not start on port 5050 within 60s")
          PY

      # -------------------------------------------------
      # Initialize database schema
      # -------------------------------------------------
      - name: Initialize database
        run: |
          python - <<'PY'
          import mysql.connector
          import time
          
          # Wait for MySQL to be ready
          deadline = time.time() + 60
          while time.time() < deadline:
              try:
                  conn = mysql.connector.connect(
                      host="127.0.0.1",
                      user="root",
                      password="root"
                  )
                  conn.close()
                  break
              except Exception:
                  time.sleep(1)
          
          # Connect and initialize
          conn = mysql.connector.connect(
              host="127.0.0.1",
              user="root",
              password="root"
          )
          cursor = conn.cursor()
          
          # Create database if not exists
          cursor.execute("CREATE DATABASE IF NOT EXISTS gsm_test")
          cursor.execute("USE gsm_test")
          
          # Create tables
          cursor.execute("""
              CREATE TABLE IF NOT EXISTS uom (
                  uom_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  uom_name VARCHAR(45) NOT NULL
              );
          """)
          
          cursor.execute("""
              CREATE TABLE IF NOT EXISTS products (
                  product_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  name VARCHAR(100) NOT NULL,
                  uom_id INT NOT NULL,
                  price_per_unit DOUBLE NOT NULL,
                  selling_price DOUBLE NOT NULL DEFAULT 0,
                  quantity INT NOT NULL DEFAULT 0,
                  FOREIGN KEY (uom_id) REFERENCES uom(uom_id)
              );
          """)
          
          cursor.execute("""
              CREATE TABLE IF NOT EXISTS orders (
                  order_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  customer_name VARCHAR(100) NOT NULL,
                  total_price DOUBLE NOT NULL,
                  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
              );
          """)
          
          cursor.execute("""
              CREATE TABLE IF NOT EXISTS order_details (
                  order_details_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  order_id INT NOT NULL,
                  product_id INT NOT NULL,
                  quantity INT NOT NULL,
                  price DOUBLE NOT NULL,
                  FOREIGN KEY (order_id) REFERENCES orders(order_id),
                  FOREIGN KEY (product_id) REFERENCES products(product_id)
              );
          """)
          
          # Seed data
          cursor.execute("INSERT INTO uom (uom_name) VALUES ('kg'), ('each'), ('litre')")
          cursor.execute("""
              INSERT INTO products (name, uom_id, price_per_unit, selling_price, quantity) VALUES
              ('Apple', 1, 1.50, 3.00, 100),
              ('Orange', 1, 3.00, 6.00, 80),
              ('Toothpaste', 2, 10.00, 20.00, 40),
              ('Milk', 3, 6.00, 12.00, 50)
          """)
          
          conn.commit()
          cursor.close()
          conn.close()
          print("✔ Database initialized")
          PY

      # -------------------------------------------------
      # Integration tests
      # -------------------------------------------------
      - name: Run integration tests
        run: pytest tests/integration -v

      # -------------------------------------------------
      # Node.js & Frontend setup
      # -------------------------------------------------
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: UI
        run: npm install

      - name: Run ESLint
        working-directory: UI
        run: npx eslint "**/*.js" || true

      # -------------------------------------------------
      # Postman tests
      # -------------------------------------------------
      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman collection
        working-directory: tests/integration/postman
        run: |
          newman run "Grocery Store Manager With Tests(GSM).postman_collection.json" \
            --env-var BASE_URL="${BASE_URL}"

      # -------------------------------------------------
      # E2E tests – Playwright
      # -------------------------------------------------
      - name: Install http-server
        run: npm install -g http-server

      - name: Start frontend server (background on :8000)
        run: |
          nohup http-server -p 8000 > /tmp/frontend.log 2>&1 &
          echo $! > /tmp/frontend.pid
        working-directory: ./UI

      - name: Wait for frontend on :8000
        run: |
          for i in {1..60}; do
            curl -fsS "${FRONTEND_URL}/index.html" && exit 0
            sleep 1
          done
          echo "Frontend did not start on ${FRONTEND_URL} within 60s"
          exit 1

      - name: Install Playwright browsers
        run: pip install pytest-playwright && playwright install

      - name: Run E2E tests
        run: pytest tests/e2e -v

      # -------------------------------------------------
      # Debug logs on failure
      # -------------------------------------------------
      - name: Show logs on failure
        if: failure()
        run: |
          echo "==== backend.log ===="
          sed -n '1,200p' /tmp/backend.log || true
          echo "==== frontend.log ===="
          sed -n '1,200p' /tmp/frontend.log || true
