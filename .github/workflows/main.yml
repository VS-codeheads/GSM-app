name: CI

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      BASE_URL: http://127.0.0.1:5000
      FRONTEND_URL: http://127.0.0.1:8000

    steps:
      # -------------------------------------------------
      # Checkout & Python setup
      # -------------------------------------------------
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov pylint

      # -------------------------------------------------
      # Static analysis – Pylint
      # -------------------------------------------------
      - name: Run Pylint
        run: |
          pylint backend/**/*.py || true

      # -------------------------------------------------
      # Unit tests
      # -------------------------------------------------
      - name: Run unit tests
        run: pytest tests/unittest --cov=backend --cov-report=term

      # -------------------------------------------------
      # Start Flask backend
      # -------------------------------------------------
      - name: Start Flask backend (background)
        run: |
          nohup python -m backend.app > /tmp/backend.log 2>&1 &
          echo $! > /tmp/backend.pid

      - name: Wait for backend on :5000
        run: |
          python - <<'PY'
          import socket, time, sys
          deadline = time.time() + 60
          while time.time() < deadline:
              try:
                  sock = socket.socket()
                  sock.settimeout(1)
                  sock.connect(("127.0.0.1", 5000))
                  sock.close()
                  sys.exit(0)
              except Exception:
                  time.sleep(1)
          sys.exit("Backend did not start on port 5000 within 60s")
          PY

      # -------------------------------------------------
      # Integration tests
      # -------------------------------------------------
      - name: Run integration tests
        run: pytest tests/integration -v

      # -------------------------------------------------
      # Node.js & Frontend setup
      # -------------------------------------------------
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: UI
        run: npm install

      - name: Run ESLint
        working-directory: UI
        run: npx eslint "**/*.js" || true

      # -------------------------------------------------
      # Postman tests
      # -------------------------------------------------
      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman collection
        working-directory: tests/integration/postman
        run: |
          newman run "Grocery Store Manager With Tests(GSM).postman_collection.json" \
            --env-var BASE_URL="${BASE_URL}"

      # -------------------------------------------------
      # E2E tests – Playwright
      # -------------------------------------------------
      - name: Install http-server
        run: npm install -g http-server

      - name: Start frontend server (background on :8000)
        run: |
          nohup http-server -p 8000 > /tmp/frontend.log 2>&1 &
          echo $! > /tmp/frontend.pid
        working-directory: ./UI

      - name: Wait for frontend on :8000
        run: |
          for i in {1..60}; do
            curl -fsS "${FRONTEND_URL}/index.html" && exit 0
            sleep 1
          done
          echo "Frontend did not start on ${FRONTEND_URL} within 60s"
          exit 1

      - name: Install Playwright browsers
        run: pip install pytest-playwright && playwright install

      - name: Run E2E tests
        run: pytest tests/e2e -v

      # -------------------------------------------------
      # Debug logs on failure
      # -------------------------------------------------
      - name: Show logs on failure
        if: failure()
        run: |
          echo "==== backend.log ===="
          sed -n '1,200p' /tmp/backend.log || true
          echo "==== frontend.log ===="
          sed -n '1,200p' /tmp/frontend.log || true
