name: CI

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches: [ main ]

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest

    env:
      BACKEND_PORT: 5050
      BACKEND_URL: http://127.0.0.1:5050
      FRONTEND_PORT: 8000
      FRONTEND_URL: http://127.0.0.1:8000
      CI: true

    steps:
    # -------------------------------------------------
    # Checkout
    # -------------------------------------------------
    - uses: actions/checkout@v4

    # -------------------------------------------------
    # Python setup
    # -------------------------------------------------
    - uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install backend dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-mock pytest-cov pylint python-dotenv

    # -------------------------------------------------
    # Static analysis – Python (Pylint)
    # -------------------------------------------------
    - name: Run Pylint
      working-directory: backend
      run: |
        pylint $(git ls-files '*.py') || true

    # -------------------------------------------------
    # Unit tests + coverage
    # -------------------------------------------------
    - name: Run unit tests with coverage
      run: |
        pytest tests/unittest \
          --cov=backend \
          --cov-report=xml \
          --cov-report=term

    # -------------------------------------------------
    # Start Flask backend
    # -------------------------------------------------
    - name: Start Flask backend
      working-directory: backend
      run: |
        export PYTHONPATH=.
        nohup python app.py > /tmp/backend.log 2>&1 &
        echo $! > /tmp/backend.pid

    - name: Wait for backend
      run: |
        echo "Waiting for backend..."
        for i in {1..60}; do
          curl -fsS "${BACKEND_URL}/getProducts" && exit 0
          sleep 1
        done
        echo "Backend failed to start!"
        exit 1

    # -------------------------------------------------
    # Node.js setup
    # -------------------------------------------------
    - uses: actions/setup-node@v4
      with:
        node-version: "20"

    # -------------------------------------------------
    # Static analysis – Frontend (ESLint)
    # -------------------------------------------------
    - name: Install ESLint
      working-directory: UI
      run: |
        npm init -y
        npm install eslint --save-dev

    - name: Run ESLint
      working-directory: UI
      run: |
        npx eslint "**/*.js" || true

    # -------------------------------------------------
    # Integration tests – Postman
    # -------------------------------------------------
    - name: Install Newman
      run: npm install -g newman

    - name: Run Postman tests
      working-directory: tests/integration/postman
      run: |
        newman run GSM.postman_collection.json \
          --env-var BASE_URL="${BACKEND_URL}"

    # -------------------------------------------------
    # Frontend server for E2E
    # -------------------------------------------------
    - name: Install http-server
      run: npm install -g http-server

    - name: Start frontend
      working-directory: UI
      run: |
        nohup http-server -p 8000 > /tmp/frontend.log 2>&1 &
        echo $! > /tmp/frontend.pid

    - name: Wait for frontend
      run: |
        for i in {1..60}; do
          curl -fsS "${FRONTEND_URL}/index.html" && exit 0
          sleep 1
        done
        echo "Frontend failed to start!"
        exit 1

    # -------------------------------------------------
    # E2E tests – Playwright
    # -------------------------------------------------
    - name: Install Playwright
      run: |
        pip install pytest-playwright
        playwright install chromium

    - name: Run E2E tests
      run: pytest tests/e2e

    # -------------------------------------------------
    # SonarCloud analysis
    # -------------------------------------------------
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=VS-codeheads_GSM-app
          -Dsonar.organization=vs-codeheads
          -Dsonar.python.coverage.reportPaths=coverage.xml

    # -------------------------------------------------
    # Debug logs
    # -------------------------------------------------
    - name: Dump logs on failure
      if: failure()
      run: |
        echo "=== BACKEND LOG ==="
        sed -n '1,200p' /tmp/backend.log || true

        echo "=== FRONTEND LOG ==="
        sed -n '1,200p' /tmp/frontend.log || true
